name: CI
on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  backend:
    name: Backend (TypeScript)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Survivor_Pool/Backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: Survivor_Pool/Backend/package-lock.json
      - run: npm ci
      - name: Prisma generate (optional)
        run: |
          if [ -f src/prisma/schema.prisma ]; then npx prisma generate --schema=src/prisma/schema.prisma; fi
      - run: npm run build
      - name: Archive backend dist
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist
          path: Survivor_Pool/Backend/dist

  frontend:
    name: Frontend (Vite + Yarn)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Survivor_Pool/Survivor
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
          cache-dependency-path: Survivor_Pool/Survivor/yarn.lock
      - run: yarn install --frozen-lockfile || yarn install
      - run: yarn build
      - name: Add SPA fallback for GitHub Pages
        run: |
          if [ -d dist ]; then cp dist/index.html dist/404.html; fi
      - name: Archive frontend dist
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: Survivor_Pool/Survivor/dist
          if-no-files-found: ignore
